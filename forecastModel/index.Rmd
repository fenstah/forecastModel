---
title       : The Power of Forecasting Sales 
subtitle    : Forecasting using Hyndman and Athanasopoulos Methods
author      : Lenny Fenster
job         : CTO
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
widgets     : [bootstrap, shiny, interactive, mathjax]            # {mathjax, quiz, bootstrap}
mode        : standalone    # {standalone, draft}
knit        : slidify::knit2slides
--- 

<style>
.title-slide {background-color: #FFF}
</style>

## Why Forecast

1. Bad forecasts may be dangerous and business killers
2. Understanding forecast trends and seasonality can help make better decisions
3. Forecasts assume the environment is changing but make no assumptions as to 
_HOW_ it is changing. 

<br/><br/>
Why doesn't everyone forecast?
>- Good forecasting is difficult.

--- 

## Types of Forecasting Methods

1. __Average (Mean)__:  forecasts of all future values are equal to the mean of the historical data.
2. __Naive__: 
    forecasts are simply set to be the value of the last observation
3. __Seasonal Naive__: 
    forecast are set to the last observed value from the same season of the year (e.g., the same month of the previous year).
4. __Regression__:
    forecast and predictor variables are assumed to be related by the simple linear model
5. __Exponential Smoothing__:
    Between Average and Naive; attaches larger weights to more recent observations than to observations from the distant past. Forecasts are calculated using weighted averages where the weights decrease exponentially as observations come from further in the past
6. __Arima__:
    While exponential smoothing models were based on a description of trend and seasonality in the data, ARIMA models aim to describe the autocorrelations in the data
7. __Neural Network__:
    Based on simple mathematical models of the brain. They allow complex nonlinear relationships between the response variable and its predictors


---

## Targets and Forecast Length

- __Targets__: Quota set for the sales organization prior to the start of the fiscal year.  
Ideally set on observed seasonality but often not done with a robust forecasting method.  
Showing targets against forecast can help identify the kind of gap we might expect versus the 
initial targets

- __Forecast Length__:  As the forecast length (in units of months for this example) increase, 
the prediciton confidence will generally decrease.  It can be valuable to vary the amount of time
for which one wants to forecast. For example, we will default to six months to forecast until the end 
of the fiscal year but may want to decrease that number to forecast how we might end the current 
quarter.

---

## Putting it all together
- Forecast Method : Exponential Smoothing
- Show Targets: TRUE
- Forecast length: Six Months

```{r echo=FALSE, fig.align='center', fig.height=6}
targets<-c(8881435,15740782,25105396,11531005,13416427,18873008,10479056,10124275,20615725,11746634,14883688,27144702)
ts.targets<-ts(targets, start=c(2015,1), freq=12)
                                                       
yoy.total.nws<-read.csv("data/YOY_NWS.csv")
yoy.total.nws<-yoy.total.nws[1:6]
yoy.total.byMonth<-with(yoy.total.nws, aggregate(Sum.of.NWS.MS.Amt.CUS, by=list(NWS.Creditted....MS.Fiscal.Month.Alt.Name), sum))
yoy.total.byMonth<-yoy.total.byMonth[-length(yoy.total.byMonth$Group.1),]
colnames(yoy.total.byMonth)<-c("Fiscal.Month", "NWS.Total.PreAudit")

options(scipen=5)
plotForecast <- function (filter, forecastMethod, filterLabel, targets=NULL, forecastperiods=6) {
        timeSeries<-ts(filter[,2],start=c(2013,1), freq=12)
        fit<-switch(forecastMethod, 
                    "regression" = tslm(timeSeries ~ trend + season -1),
                    "ets" = ets(timeSeries),
                    "mean" = meanf(timeSeries, h=forecastperiods),
                    "naive" = naive(timeSeries, h=forecastperiods),
                    "snaive" = snaive(timeSeries, h=forecastperiods),
                    "arima" = auto.arima(timeSeries),
                    "nnet" = nnetar(timeSeries))
        fcst<-forecast(fit, h=forecastperiods)
        projectedNWS<-sum(subset(filter, grepl("^FY2015", Fiscal.Month))[2],fcst$mean)
        subTitle<-paste("forecast=",format(projectedNWS,big.mark=",",scientific=F))
        plot(fcst, main=paste("Sales Forecast (",filterLabel,")"), sub=subTitle)
        lines(fitted(fit), col=2)
        if(!is.null(targets)) {
            lines(ts.targets, col=3, lwd = 4)
            legend("topleft", lty=1, col=c(1,2,3), legend=c("Actual", "Predicted", "Targets"))
        }
        else legend("topleft", lty=1, col=c(1,2), legend=c("Actual", "Predicted"))        
    }

plotForecast(yoy.total.byMonth, "snaive", "Seasonal Naive", ts.targets, 6)
```

--- 

## Determining Forecast Accuracy
Forecast error is $e_{i}=y_{i}-\hat{y}_{i}$ where $y_{i}$ denotes  the _i_ th observation and $\hat{y}_{i}$ denotes a forecast of $y_{i}$. Types of measuring forecast accuracy are:
$$
\begin{aligned} 
\text{Mean absolute error: MAE} = \text{mean}(|e_{i}|),\\
\text{Root mean squared error: RMSE} = \sqrt{\text{mean}(e_{i}^2)},\\
\text{Mean absolute percentage error: MAPE} = \text{mean}(|p_{i}|),\\
\text{MASE} = \text{mean}(|q_{j}|).
\end{aligned}
$$

The forecast accuracy measures for the seasonal naive forecast in the previous slide are:
```{r echo=FALSE}
getAccuracy <- function (filter, forecastMethod, forecastperiods=6) {
        timeSeries<-ts(filter[,2],start=c(2013,1), freq=12)
        fit<-switch(forecastMethod, 
                    "regression" = tslm(timeSeries ~ trend + season -1),
                    "ets" = ets(timeSeries, model="AAN"),
                    "mean" = meanf(timeSeries, h=forecastperiods),
                    "naive" = naive(timeSeries, h=forecastperiods),
                    "snaive" = snaive(timeSeries, h=forecastperiods),
                    "arima" = auto.arima(timeSeries),
                    "nnet" = nnetar(timeSeries))
        return (accuracy(fit))
    }

getAccuracy(yoy.total.byMonth, "snaive", 6)
```


